<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hororové Príbehy: Baldi's Basics V10 - Roblox (Vyžaduje Prihlásenie)</title>
    
    <!-- PRIDANÁ WEB IKONA (FAVICON) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📏</text></svg>">

    <!-- Načítanie Tailwind CSS pre moderný a responzívny dizajn -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Nastavenie fontu a vlastnej temnej, nepríjemnej farby pozadia */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Veľmi tmavá šedá */
            color: #e5e5e5; /* Svetlá farba textu */
            /* Pridanie jemnej, rušivej textúry na pozadie */
            background-image: url('https://placehold.co/10x10/1a1a1a/222?text=.');
            background-repeat: repeat;
        }
        /* Štýl pre sekcie s jemným tieňom a zaoblenými rohmi (Wix-like) */
        .story-card {
            background-color: #222222;
            border: 1px solid #333333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(189, 0, 0, 0.2); /* Jemný červený tieň pre horor */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 30px rgba(255, 0, 0, 0.5);
        }
        .text-accent {
            color: #ff4444; /* Červený akcent pre titulky/dôraz */
        }
        .tts-button {
            /* Základný štýl tlačidla */
        }
        /* Zabezpečenie, že telo aplikácie zaberá celú výšku pre centrovanie */
        .full-screen-center {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
    <!-- Font Inter (predvolený pre Tailwind, ale pre istotu) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigácia/Hlavička - pevná, tmavá lišta -->
    <header class="bg-black bg-opacity-80 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-accent tracking-wider uppercase">
                Baldi's Nightmare (V10)
            </h1>
            <nav class="hidden md:flex space-x-6 items-center">
                <a href="#pribehy" id="nav-stories" class="text-gray-300 hover:text-white transition duration-300 hidden">Príbehy</a>
                <a href="#autori" id="nav-authors" class="text-gray-300 hover:text-white transition duration-300 hidden">O Autóroch</a>
                <!-- ODKAZ NA ROBLOX HRU -->
                <a href="https://www.roblox.com/share?code=c927009cc56d644fbd071b9bf5838441&type=ExperienceDetails&stamp=1759164339007" target="_blank" id="nav-roblox" class="text-gray-300 hover:text-white transition duration-300 hidden">Roblox Hra</a>
                <!-- TLAČIDLO ODHLÁSENIA -->
                <button id="logout-button" onclick="handleLogout()" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md transition duration-300 hidden">Odhlásiť sa</button>
                <span id="user-info" class="text-xs text-gray-400 hidden"></span>
            </nav>
            <!-- Hamburger menu pre mobilné zariadenia (ponechaný, ale skrytý pre zjednodušenie) -->
            <button class="md:hidden p-2 rounded-lg text-gray-300 hover:bg-gray-700 hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
    </header>

    <!-- Hlavný obsah -->
    <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Autentifikačná obrazovka (viditeľná pred prihlásením) -->
        <div id="auth-screen" class="full-screen-center text-center">
            <div class="max-w-lg mx-auto story-card p-8 md:p-10 rounded-xl">
                <h3 id="auth-title" class="text-3xl font-bold text-accent mb-6">Prihláste sa pre prístup k Hororom</h3>
                
                <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit()">
                    <input type="email" id="email" placeholder="E-mail" required
                           class="w-full p-3 mb-4 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                    <input type="password" id="password" placeholder="Heslo" required
                           class="w-full p-3 mb-6 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">

                    <button type="submit" id="auth-submit-btn" 
                            class="w-full bg-accent hover:bg-red-700 text-white text-lg font-semibold py-3 rounded-lg transition duration-300 shadow-md shadow-red-900/50">
                        Prihlásiť sa
                    </button>
                </form>

                <div class="mt-6">
                    <button id="toggle-auth-btn" onclick="toggleAuthMode()"
                            class="text-sm text-gray-400 hover:text-accent transition duration-300">
                        Nemáte účet? **Zaregistrujte sa**
                    </button>
                </div>
                
                <p id="auth-error-message" class="text-red-400 text-sm mt-4 hidden">
                    <!-- Chyby autentifikácie sa zobrazia tu -->
                </p>
                <p id="auth-loader" class="text-accent text-sm mt-4 hidden">
                    Prebieha overenie...
                </p>
            </div>
        </div>

        <!-- Obsah aplikácie (skrytý, kým nie je používateľ prihlásený) -->
        <div id="app-content" class="hidden">
            <div class="text-center py-16 md:py-24 bg-black bg-opacity-50 rounded-xl shadow-2xl mb-12">
                <p class="text-sm font-semibold uppercase tracking-widest text-gray-400 mb-2">Roblox Horor Fanfiction</p>
                <h2 class="text-5xl md:text-7xl font-extrabold text-white mb-4 leading-tight">
                    ZÁPISKY Z TEMNÉHO BLOKU
                </h2>
                <p class="text-lg text-gray-400 max-w-2xl mx-auto">
                    Nevysvetlené javy a desivé príbehy inšpirované hrou **Baldi's Basics Classic V10** od **GAMEPLA631** a **Oz Spoločenstvo**.
                </p>
            </div>

            <!-- NOVÁ Sekcia: CTA pre hru -->
            <div class="text-center mb-12">
                <a href="https://www.roblox.com/share?code=c927009cc56d644fbd071b9bf5838441&type=ExperienceDetails&stamp=1759164339007" target="_blank" 
                   class="inline-block bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-10 rounded-xl transition duration-300 transform hover:scale-105 shadow-lg shadow-green-900/50">
                    HRAJTE NAŠU HRU V10 NA ROBLOXE TERAZ!
                </a>
            </div>
            
            <!-- Sekcia s Príbehmi -->
            <section id="pribehy" class="mb-12">
                <h3 class="text-4xl font-bold text-accent mb-8 border-b-2 border-accent pb-2">Najnovšie Príbehy</h3>
                
                <!-- TTS Upozornenie -->
                <div id="tts-warning" class="bg-red-900 bg-opacity-30 border border-red-700 p-4 rounded-lg mb-6 hidden">
                    <p class="text-sm text-red-300 font-medium">
                        <span class="font-bold">Upozornenie:</span> Váš prehliadač nepodporuje funkciu čítania nahlas (Web Speech API) alebo je vypnutá.
                    </p>
                </div>

                <!-- NOVÝ Príbeh: Šialenstvo V10: Absolútna Rýchlosť (ÚPLNÝ TEXT) -->
                <div class="story-card p-6 md:p-8 rounded-xl mb-8">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Placeholder pre obrázok príbehu -->
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <img src="https://placehold.co/400x250/550000/ff4444?text=BALDI%20V10%20(Transformácia)" alt="[Obrázok Baldiho a školy V10]" class="rounded-lg w-full h-auto object-cover border-2 border-red-900">
                        </div>
                        <!-- Text príbehu a ovládanie TTS -->
                        <div class="w-full md:w-2/3">
                            <p class="text-xs uppercase text-gray-500 mb-2">Kategória: Hlavný Lore / V10 Zlyhanie | Oz Spoločenstvo</p>
                            <h4 class="text-3xl font-bold text-accent mb-3">Šialenstvo V10: Absolútna Rýchlosť</h4>
                            <p id="story-v10-madness" class="text-gray-400 mb-4 leading-relaxed">
                                Stará škola nebola postavená na učenie, ale na trest. A učiteľ Baldi, ktorý tu kedysi s nadšením učil, bol jej prvou a najväčšou obeťou.<br><br>
                                Hovorilo sa, že na začiatku, vo Verzii V5, bol iba prísny. Trestal palicou len tých, ktorí nepochopili matematiku. Bol to len Badli, ktorý mal zlý deň.<br>
                                Ale potom prišla **V10**.<br><br>
                                Nikto presne nevedel, čo sa stalo. Niektorí hovorili, že to bolo neustále zlyhanie žiakov. Iní, že sa v Baldiho hlavnej triede zjavilo niečo temné. Ale keď sa škola aktualizovala na V10, učiteľ už nebol. Bol len **On**.<br><br>
                                Jeho koža bola chorobne bledá, oči žiarili neprirodzenou žltou farbou ako dve prasknuté žiarovky. Jeho tvár, predtým len prísna, sa stala zmesou manickej hrôzy a šialeného úsmevu. Pravítko už nebolo didaktická pomôcka; bol to nástroj na rozsekávanie ticha.<br><br>
                                Baldi vo V10 nechcel odpovede. Chcel paniku.<br><br>
                                Matematické zošity sa zmenili na náhodné, nepochopiteľné škvrny od čierneho atramentu, ktoré nebolo možné vyriešiť. V okamihu, keď ste zobrali pero, ozvalo sa **TAP-TAP-TAP**.<br>
                                To nebol Baldiho krok. Bol to zvuk jeho pravítka, ktoré sa dotklo dverí triedy.<br><br>
                                Bol stokrát rýchlejší. Nepotreboval čas, aby sa k vám dostal. Bol všade. V momente, keď ste zle spočítali aj ten najjednoduchší príklad (hoci všetky boli nerozlúštiteľné), Baldi sa prepol do stavu čistej, nefiltrovanej rýchlosti. Videl vás za stenami, v šere chodieb. Vedel, kde sa skrývate, a bežal s takou rýchlosťou, že zvuk jeho krokov sa menil na vysoký, pískľavý tón, ktorý vás mučil.<br><br>
                                Keď vás chytil Riaditeľ, aby vás zatvoril do riaditeľne, nebol to už len trest. Bol to posledný dar času pre Baldiho, aby k vám dobehol. Riaditeľova silueta, ktorá vás odhodila pred dvere, bola v skutočnosti siluetou, ktorá vás servírovala Baldiho šialenstvu.<br><br>
                                V10 bola hororom o tom, že systém sa zrútil. Učiteľ, ktorý vás mal viesť, sa stal vaším najrýchlejším a najhladnejším prenasledovateľom. A s každou novou aktualizáciou – smerom k desivej **V100** – sa Baldiho šialenstvo len prehlbuje a jeho rýchlosť sa stáva absolútnou. Hráči vo V10 už nehrajú o známky. Hrajú o to, ako dlho dokážu prežiť vo fyzicky nemožnom systéme, ktorý je riadený čírou hrôzou.
                            </p>
                            <button class="tts-button bg-accent hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition duration-300 shadow-md shadow-red-900/50" onclick="handleTTS('story-v10-madness', this)">
                                Prečítať nahlas
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Príbeh 1: Desiaty Zápisník (posunutý dole) -->
                <div class="story-card p-6 md:p-8 rounded-xl mb-8">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Placeholder pre obrázok príbehu -->
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <img src="https://placehold.co/400x250/333333/ff4444?text=BALDI%20V10%20(Obrázok)" alt="[Obrázok Baldiho a školy]" class="rounded-lg w-full h-auto object-cover border-2 border-red-900">
                        </div>
                        <!-- Text príbehu a ovládanie TTS -->
                        <div class="w-full md:w-2/3">
                            <p class="text-xs uppercase text-gray-500 mb-2">Kategória: Pôvodný Horor | GAMEPLA631 & Oz Spoločenstvo</p>
                            <h4 class="text-3xl font-bold text-white mb-3">Desiaty Zápisník</h4>
                            <p id="story-notebook" class="text-gray-400 mb-4 leading-relaxed">
                                Škola bola tmavá, vzduch ťažký a pach kriedy bol cítiť aj cez zatvorené dvere. Nepočul som nič iné, len tiché, pomalé ťukanie dreveného pravítka do betónovej podlahy. Vedel som, že Baldi vie, že som použil **desiaty zápisník**. Ten, ktorý nikto nikdy nemal nájsť. Súčet v tretej úlohe bol $-256$, ale Baldiho odpoveď nebola chyba v rovnici... bola to **osobná správa**. Keď som sa pozrel do uličky, nebola tam len jeho postava. Bola tam tma s dvoma červenými bodkami, a zvuk ťukania prestal. Baldi nebehal. Len čakal.
                            </p>
                            <button class="tts-button bg-accent hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition duration-300 shadow-md shadow-red-900/50" onclick="handleTTS('story-notebook', this)">
                                Prečítať nahlas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Príbeh 2: Zvuk Skákania -->
                <div class="story-card p-6 md:p-8 rounded-xl mb-8">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <img src="https://placehold.co/400x250/333333/ff4444?text=PLAYTIME%20(Obrázok)" alt="[Obrázok Playtime a laná]" class="rounded-lg w-full h-auto object-cover border-2 border-red-900">
                        </div>
                        <!-- Text príbehu a ovládanie TTS -->
                        <div class="w-full md:w-2/3">
                            <p class="text-xs uppercase text-gray-500 mb-2">Kategória: Charakterový Horor | GAMEPLA631</p>
                            <h4 class="text-3xl font-bold text-white mb-3">Zvuk Skákania</h4>
                            <p id="story-jumping" class="text-gray-400 mb-4 leading-relaxed">
                                Playtime bola vždy otravná. Jej preskakovanie cez švihadlo bolo rituálom, hlučným signálom blížiacich sa problémov. Ale v budove V10 sa to zmenilo. Zvuk sa ozýval z vetracích šácht. Bolo to rytmické, ale tlmené. Akoby skákala vo veľmi malom, stiesnenom priestore. A nebol to detský smiech, ktorý ju sprevádzal, ale tiché, opakované chrčanie. Keď som otvoril skrinku, aby som sa schoval, zistil som, že šnúrky sú len predĺžené, tenké šľachy.
                            </p>
                            <button class="tts-button bg-accent hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition duration-300 shadow-md shadow-red-900/50" onclick="handleTTS('story-jumping', this)">
                                Prečítať nahlas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Príbeh 3: The Principal's Warning -->
                <div class="story-card p-6 md:p-8 rounded-xl mb-8">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <img src="https://placehold.co/400x250/333333/ff4444?text=PRINCIPAL%20(Obrázok)" alt="[Obrázok Riaditeľa v tme]" class="rounded-lg w-full h-auto object-cover border-2 border-red-900">
                        </div>
                        <!-- Text príbehu a ovládanie TTS -->
                        <div class="w-full md:w-2/3">
                            <p class="text-xs uppercase text-gray-500 mb-2">Kategória: Psychologický Horor | Oz Spoločenstvo</p>
                            <h4 class="text-3xl font-bold text-white mb-3">Riaditeľovo Ticho</h4>
                            <p id="story-principal" class="text-gray-400 mb-4 leading-relaxed">
                                "Si zadržaný. Navždy." povedal Riaditeľ, a tentoraz to nebola len hrozba. Miesto jeho kancelárie bola teraz len biela izba bez dverí. Hodiny viseli v strede a stále ukazovali 7:00. Nechal ma tam, aby som čakal na trest, ale Baldi už nechodil. Ani Playtime. Bola tam len tma vonku a v bielom svetle som videl, ako sa Riaditeľov tieň na stene predlžuje a stáva sa tenším... a nakoniec sa premení na niečo, čo má presne sedem stôp dlhé pravítko.
                            </p>
                            <button class="tts-button bg-accent hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full transition duration-300 shadow-md shadow-red-900/50" onclick="handleTTS('story-principal', this)">
                                Prečítať nahlas
                            </button>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Sekcia o Autóroch -->
            <section id="autori" class="text-center py-12 border-t border-gray-700 mt-12">
                <h3 class="text-3xl font-bold text-white mb-4">O Autóroch Hry</h3>
                <p class="text-lg text-gray-400 max-w-xl mx-auto mb-6">
                    Táto fan-stránka je venovaná desivým príbehom, ktoré vznikli na základe hry **Baldi's Basics Classic V10** na platforme Roblox.
                </p>
                <div class="flex justify-center space-x-8">
                    <div class="p-4 rounded-lg bg-gray-800 shadow-xl w-48">
                        <h4 class="text-xl font-semibold text-accent">GAMEPLA631</h4>
                        <p class="text-sm text-gray-400 mt-2">Hlavný Tvorca</p>
                        <p class="text-xs text-gray-500 mt-1">Ďakujeme za temnú inšpiráciu!</p>
                    </div>
                    <div class="p-4 rounded-lg bg-gray-800 shadow-xl w-48">
                        <h4 class="text-xl font-semibold text-accent">Oz Spoločenstvo</h4>
                        <p class="text-sm text-gray-400 mt-2">Spolutvorca / Komunita</p>
                        <p class="text-xs text-gray-500 mt-1">Prekračovanie hraníc strachu.</p>
                    </div>
                </div>
            </section>
        </div>

    </main>

    <!-- Pätička -->
    <footer class="bg-black bg-opacity-80 mt-12 py-6 text-center text-sm text-gray-500">
        <p>
            &copy; 2024 Zápisky z Temného Bloku. Fan-projekt. Všetky práva k hre Baldi's Basics Classic V10 patria
            **GAMEPLA631** a **Oz Spoločenstvo**. Roblox.
        </p>
    </footer>

<script type="module">
    // --- LOKÁLNA AUTENTIFIKÁCIA A STORAGE (BROWSER) ---
    // POUŽÍVAME Local Storage na ukladanie údajov priamo v prehliadači.
    const USERS_KEY = 'baldi_local_users_map'; // Kľúč pre mapu všetkých registrovaných užívateľov
    const LOGGED_IN_EMAIL_KEY = 'baldi_logged_in_email'; // Ukladá e-mail aktuálne prihláseného užívateľa
    let authMode = 'login'; // 'login' alebo 'register'

    /**
     * Načíta mapu všetkých registrovaných užívateľov.
     * @returns {object} Mapa užívateľov, kde kľúčom je e-mail.
     */
    function getStoredUsersMap() {
        try {
            const usersJson = localStorage.getItem(USERS_KEY);
            // Ak Local Storage vracia null, vrátime prázdny objekt (mapu)
            return usersJson ? JSON.parse(usersJson) : {};
        } catch (e) {
            console.error("Chyba pri čítaní mapy užívateľov z Local Storage:", e);
            return {};
        }
    }

    /**
     * Uloží mapu všetkých registrovaných užívateľov.
     * @param {object} usersMap - Mapa užívateľov.
     */
    function setStoredUsersMap(usersMap) {
        localStorage.setItem(USERS_KEY, JSON.stringify(usersMap));
    }
    
    /**
     * Získa aktuálne prihláseného užívateľa.
     * @returns {object|null} Objekt prihláseného užívateľa s pridaným kľúčom 'isLoggedIn', alebo null.
     */
    function getLoggedInUser() {
        const loggedInEmail = localStorage.getItem(LOGGED_IN_EMAIL_KEY);
        if (!loggedInEmail) return null;

        const usersMap = getStoredUsersMap();
        const user = usersMap[loggedInEmail];

        // Vráti užívateľský objekt s príznakom, že je prihlásený.
        return user ? { ...user, isLoggedIn: true } : null;
    }

    /**
     * Nastaví stav prihlásenia pre daný e-mail.
     * @param {string} email - E-mail užívateľa, ktorý sa prihlásil.
     */
    function setLoggedInState(email) {
        localStorage.setItem(LOGGED_IN_EMAIL_KEY, email);
    }

    /**
     * Vymaže stav prihlásenia.
     */
    window.clearLoggedInState = function() { // Exportované pre handleLogout
        localStorage.removeItem(LOGGED_IN_EMAIL_KEY);
    }
    
    /**
     * Aktualizuje viditeľnosť UI prvkov na základe stavu prihlásenia.
     * @param {object|null} user - Aktuálny užívateľský objekt (z getLoggedInUser).
     */
    function updateUI(user) {
        if (user && user.isLoggedIn) {
            // Používateľ je prihlásený, ukáž obsah
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('logout-button').classList.remove('hidden');
            // Zobrazíme e-mail
            document.getElementById('user-info').textContent = `Prihlásený (LOKÁLNE): ${user.email}`;
            document.getElementById('user-info').classList.remove('hidden');

            // Ukáž navigáciu
            document.getElementById('nav-stories').classList.remove('hidden');
            document.getElementById('nav-authors').classList.remove('hidden');
            document.getElementById('nav-roblox').classList.remove('hidden');
        } else {
            // Používateľ nie je prihlásený, ukáž prihlasovací formulár
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('logout-button').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');

            // Skry navigáciu
            document.getElementById('nav-stories').classList.add('hidden');
            document.getElementById('nav-authors').classList.add('hidden');
            document.getElementById('nav-roblox').classList.add('hidden');
        }
    }

    /**
     * Inicializácia pri načítaní stránky: skontroluje, či je užívateľ lokálne prihlásený.
     */
    function initializeAuth() {
        const user = getLoggedInUser();
        updateUI(user);
    }

    // --- OBSLUŽNÉ FUNKCIE PRE FORMULÁR ---

    /**
     * Prepína medzi režimami 'prihlásenie' a 'registrácia'.
     */
    window.toggleAuthMode = function() {
        authMode = authMode === 'login' ? 'register' : 'login';
        const title = document.getElementById('auth-title');
        const submitBtn = document.getElementById('auth-submit-btn');
        const toggleBtn = document.getElementById('toggle-auth-btn');

        if (authMode === 'register') {
            title.textContent = 'Registrácia nového účtu';
            submitBtn.textContent = 'Zaregistrovať sa';
            toggleBtn.innerHTML = 'Už máte účet? **Prihláste sa**';
        } else {
            title.textContent = 'Prihláste sa pre prístup k Hororom';
            submitBtn.textContent = 'Prihlásiť sa';
            toggleBtn.innerHTML = 'Nemáte účet? **Zaregistrujte sa**';
        }
        document.getElementById('auth-error-message').classList.add('hidden');
    }

    /**
     * Spracováva odoslanie formulára (prihlásenie alebo registrácia) pomocou Local Storage.
     */
    window.handleAuthSubmit = async function() {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMsg = document.getElementById('auth-error-message');
        const loader = document.getElementById('auth-loader');
        
        const email = emailInput.value.toLowerCase().trim(); // Normalizácia e-mailu
        const password = passwordInput.value;

        errorMsg.classList.add('hidden');
        loader.classList.remove('hidden');
        
        // Načítaj mapu všetkých užívateľov
        const usersMap = getStoredUsersMap();

        try {
            if (authMode === 'register') {
                if (usersMap[email]) {
                    // Užívateľ s týmto e-mailom už je registrovaný
                    // Zmenený kód a správa pre lepšiu diagnostiku
                    throw { code: 'local/duplicate-email', message: `Tento e-mail (${email}) je už v tomto prehliadači zaregistrovaný. Prosím, prihláste sa, alebo použite iný e-mail.` };
                }
                if (password.length < 6) {
                     throw { code: 'local/weak-password', message: 'Heslo musí mať aspoň 6 znakov.' };
                }
                
                // Registrácia úspešná: Uložíme nového užívateľa do mapy a prihlásime ho
                const newUser = { email: email, password: password, uid: 'local-' + Date.now() };
                usersMap[email] = newUser;
                setStoredUsersMap(usersMap); // Uložiť celú mapu
                setLoggedInState(email); // Nastaviť stav prihlásenia
                
                updateUI({ ...newUser, isLoggedIn: true });

            } else { // Login Mode
                const storedUser = usersMap[email];
                
                if (!storedUser) {
                    // Užívateľ nebol nájdený
                     throw { code: 'local/no-user', message: 'Užívateľ s týmto e-mailom nebol nájdený. Najprv sa zaregistrujte.' };
                }

                // Overenie hesla
                if (storedUser.password === password) {
                    setLoggedInState(email); // Nastaviť stav prihlásenia
                    updateUI({ ...storedUser, isLoggedIn: true });
                } else {
                    throw { code: 'local/wrong-credentials', message: 'Nesprávne heslo.' };
                }
            }
        } catch (error) {
            let userMessage = error.message || "Vyskytla sa neznáma chyba pri autentifikácii.";
            
            // Mapovanie chybových kódov pre zobrazenie užívateľovi
            if (error.code === 'local/duplicate-email') {
                // Použijeme dynamickú správu, ktorá obsahuje email
                userMessage = error.message; 
            } else if (error.code === 'local/no-user') {
                userMessage = "Užívateľ s týmto e-mailom nebol nájdený. Skúste registráciu.";
            } else if (error.code === 'local/wrong-credentials') {
                userMessage = "Nesprávny e-mail alebo heslo.";
            } else if (error.code === 'local/weak-password') {
                 userMessage = "Heslo by malo mať aspoň 6 znakov.";
            }
            
            errorMsg.textContent = userMessage;
            errorMsg.classList.remove('hidden');
            console.error("Auth Error:", error.code, error.message);
        } finally {
            loader.classList.add('hidden');
        }
    }

    /**
     * Spracováva odhlásenie používateľa (zruší stav v Local Storage).
     */
    window.handleLogout = function() {
        clearLoggedInState();
        // UI sa zaktualizuje na prihlasovaciu obrazovku
        updateUI(getLoggedInUser());
    }

    // Spustenie inicializácie pri štarte aplikácie
    initializeAuth();


    // --- LOGIKA TTS (POUŽÍVANÁ V RÁMCI APP-CONTENT) ---
    const synth = window.speechSynthesis;
    let currentlySpeakingButton = null;

    if (!('speechSynthesis' in window)) {
        document.getElementById('tts-warning').classList.remove('hidden');
    }

    function stopSpeech() {
        if (synth.speaking) {
            synth.cancel();
        }
        
        document.querySelectorAll('.tts-button').forEach(btn => {
            btn.textContent = 'Prečítať nahlas';
            btn.classList.remove('bg-red-700');
            btn.classList.add('bg-accent');
        });
        currentlySpeakingButton = null;
    }

    function speakText(storyText, buttonElement) {
        const utterance = new SpeechSynthesisUtterance(storyText);
        utterance.lang = 'sk-SK';
        utterance.rate = 1; 
        utterance.pitch = 1;

        utterance.onstart = () => {
            buttonElement.textContent = 'Zastaviť čítanie (STOP)';
            buttonElement.classList.remove('bg-accent');
            buttonElement.classList.add('bg-red-700');
            currentlySpeakingButton = buttonElement;
        };

        utterance.onend = () => {
            buttonElement.textContent = 'Prečítať nahlas';
            buttonElement.classList.remove('bg-red-700');
            buttonElement.classList.add('bg-accent');
            currentlySpeakingButton = null;
        };
        
        utterance.onerror = (event) => {
            console.error('Speech synthesis error: ' + event.error);
            stopSpeech();
        };

        synth.speak(utterance);
    }

    window.handleTTS = function(storyId, buttonElement) {
        const storyElement = document.getElementById(storyId);
        if (!storyElement) {
            console.error('Story element not found:', storyId);
            return;
        }

        let storyText = storyElement.innerHTML
            .replace(/<br>/g, '. ')
            .replace(/\s\s+/g, ' ')
            .trim();

        if (currentlySpeakingButton === buttonElement) {
            stopSpeech();
        } else {
            const wasSpeaking = synth.speaking;
            stopSpeech(); 
            
            if (wasSpeaking) {
                 setTimeout(() => {
                    speakText(storyText, buttonElement);
                }, 50);
            } else {
                speakText(storyText, buttonElement);
            }
        }
    }
</script>

</body>
</html>




